name: inbox-bot (monthly)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/22 * * * *"

concurrency:
  group: monthly-inbox-bot
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DROPBOX_REFRESH_TOKEN: ${{ secrets.DROPBOX_REFRESH_TOKEN }}
      DROPBOX_APP_KEY: ${{ secrets.DROPBOX_APP_KEY }}
      DROPBOX_APP_SECRET: ${{ secrets.DROPBOX_APP_SECRET }}

      STATE_PATH: ${{ secrets.STATE_PATH }}
      LOGS_DIR: ${{ secrets.LOGS_DIR }}

      STAGE00_IN: ${{ secrets.STAGE00_IN }}
      STAGE00_OUT: ${{ secrets.STAGE00_OUT }}
      STAGE00_DONE: ${{ secrets.STAGE00_DONE }}

      STAGE10_IN: ${{ secrets.STAGE10_IN }}
      STAGE10_OUT: ${{ secrets.STAGE10_OUT }}
      STAGE10_DONE: ${{ secrets.STAGE10_DONE }}

      STAGE20_IN: ${{ secrets.STAGE20_IN }}
      STAGE20_OUT: ${{ secrets.STAGE20_OUT }}
      STAGE20_DONE: ${{ secrets.STAGE20_DONE }}

      STAGE30_IN: ${{ secrets.STAGE30_IN }}
      STAGE30_OUT: ${{ secrets.STAGE30_OUT }}
      STAGE30_DONE: ${{ secrets.STAGE30_DONE }}

      STAGE40_IN: ${{ secrets.STAGE40_IN }}
      STAGE40_OUT: ${{ secrets.STAGE40_OUT }}
      STAGE40_DONE: ${{ secrets.STAGE40_DONE }}

      # ★空なら 00 に倒す（ここが今回のエラー対策）
      MONTHLY_STAGE: ${{ secrets.MONTHLY_STAGE || '00' }}

      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gpt-5-mini' }}
      DEPTH: ${{ secrets.DEPTH || 'medium' }}
      OPENAI_TIMEOUT: ${{ secrets.OPENAI_TIMEOUT || '120' }}
      OPENAI_MAX_RETRIES: ${{ secrets.OPENAI_MAX_RETRIES || '2' }}
      OPENAI_MAX_OUTPUT_TOKENS: ${{ secrets.OPENAI_MAX_OUTPUT_TOKENS || '5000' }}
      MAX_FILES_PER_RUN: ${{ secrets.MAX_FILES_PER_RUN || '200' }}
      MAX_INPUT_CHARS: ${{ secrets.MAX_INPUT_CHARS || '80000' }}

      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ★安全装置：ステージに必要な Dropbox パスが空なら落とす
      - name: Guard: required env for selected stage
        shell: bash
        run: |
          set -euxo pipefail
          python - <<'PY'
          import os, sys

          stage = (os.environ.get("MONTHLY_STAGE","") or "").strip()
          if stage not in {"00","10","20","30","40"}:
            raise SystemExit(f"MONTHLY_STAGE invalid: {stage!r}")

          def need(k: str):
            v = (os.environ.get(k,"") or "").strip()
            if not v:
              raise SystemExit(f"Missing required env: {k}")
            if not v.startswith("/"):
              raise SystemExit(f"Invalid path (must start with '/'): {k}={v!r}")

          need(f"STAGE{stage}_IN")
          need(f"STAGE{stage}_OUT")
          need(f"STAGE{stage}_DONE")

          # logs/state は任意だが、使う設計ならここで必須にしてもOK
          # (今回は過去運用に合わせて任意のまま)
          print("Guard OK. stage=", stage)
          PY

      - name: Run monthly_main
        shell: bash
        run: |
          set -euxo pipefail
          python -V
          python -m compileall -q src
          python -c "import src.monthly_main; print('import ok')"
          python - <<'PY'
          import runpy, sys, time, traceback
          t0 = time.time()
          try:
            print("[wrapper] START src.monthly_main")
            runpy.run_module("src.monthly_main", run_name="__main__")
          except SystemExit as e:
            print(f"[wrapper] SystemExit: code={e.code!r}", file=sys.stderr)
            raise
          except Exception:
            print("[wrapper] Unhandled exception:", file=sys.stderr)
            traceback.print_exc()
            sys.exit(1)
          finally:
            print(f"[wrapper] END (elapsed_s={time.time()-t0:.2f})")
          PY

      - name: Write DONE marker to stage40/OUT (no overwrite)
        if: ${{ env.MONTHLY_STAGE == '40' }}
        shell: bash
        run: |
          set -euxo pipefail
          python - <<'PY'
          import os
          from datetime import datetime, timezone
          import dropbox
          from dropbox.files import WriteMode

          tok = os.environ["DROPBOX_REFRESH_TOKEN"]
          app_key = os.environ["DROPBOX_APP_KEY"]
          app_secret = os.environ["DROPBOX_APP_SECRET"]
          out_dir = (os.environ.get("STAGE40_OUT","") or "").rstrip("/")

          now = datetime.now(timezone.utc)
          ym = now.strftime("%Y-%m")
          fname = f"_DONE_{ym}.txt"
          body = f"{ym} monthly pipeline finished (stage40)\n"
          path = f"{out_dir}/{fname}"

          dbx = dropbox.Dropbox(oauth2_refresh_token=tok, app_key=app_key, app_secret=app_secret)
          res = dbx.files_upload(
            body.encode("utf-8"),
            path,
            mode=WriteMode.add,
            autorename=True,
            mute=True,
          )
          print("uploaded:", res.path_display)
          PY
