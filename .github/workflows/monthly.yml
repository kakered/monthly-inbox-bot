name: inbox-bot (monthly)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/22 * * * *"

concurrency:
  group: monthly-inbox-bot
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest

    # ★ここで secrets を env に落としておく（if では env を参照する）
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DROPBOX_REFRESH_TOKEN: ${{ secrets.DROPBOX_REFRESH_TOKEN }}
      DROPBOX_APP_KEY: ${{ secrets.DROPBOX_APP_KEY }}
      DROPBOX_APP_SECRET: ${{ secrets.DROPBOX_APP_SECRET }}

      STATE_PATH: ${{ secrets.STATE_PATH }}
      LOGS_DIR: ${{ secrets.LOGS_DIR }}

      STAGE00_IN: ${{ secrets.STAGE00_IN }}
      STAGE00_OUT: ${{ secrets.STAGE00_OUT }}
      STAGE00_DONE: ${{ secrets.STAGE00_DONE }}

      STAGE10_IN: ${{ secrets.STAGE10_IN }}
      STAGE10_OUT: ${{ secrets.STAGE10_OUT }}
      STAGE10_DONE: ${{ secrets.STAGE10_DONE }}

      STAGE20_IN: ${{ secrets.STAGE20_IN }}
      STAGE20_OUT: ${{ secrets.STAGE20_OUT }}
      STAGE20_DONE: ${{ secrets.STAGE20_DONE }}

      STAGE30_IN: ${{ secrets.STAGE30_IN }}
      STAGE30_OUT: ${{ secrets.STAGE30_OUT }}
      STAGE30_DONE: ${{ secrets.STAGE30_DONE }}

      STAGE40_IN: ${{ secrets.STAGE40_IN }}
      STAGE40_OUT: ${{ secrets.STAGE40_OUT }}
      STAGE40_DONE: ${{ secrets.STAGE40_DONE }}

      MONTHLY_STAGE: ${{ secrets.MONTHLY_STAGE }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
      DEPTH: ${{ secrets.DEPTH }}
      OPENAI_TIMEOUT: ${{ secrets.OPENAI_TIMEOUT }}
      OPENAI_MAX_RETRIES: ${{ secrets.OPENAI_MAX_RETRIES }}
      OPENAI_MAX_OUTPUT_TOKENS: ${{ secrets.OPENAI_MAX_OUTPUT_TOKENS }}
      MAX_FILES_PER_RUN: ${{ secrets.MAX_FILES_PER_RUN }}
      MAX_INPUT_CHARS: ${{ secrets.MAX_INPUT_CHARS }}

      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Debug env (length only)
        shell: bash
        run: |
          set -euxo pipefail
          python - <<'PY'
          import os, hashlib
          keys = [
            "LOGS_DIR","STATE_PATH","MONTHLY_STAGE",
            "STAGE00_IN","STAGE00_OUT","STAGE00_DONE",
            "STAGE10_IN","STAGE10_OUT","STAGE10_DONE",
            "STAGE20_IN","STAGE20_OUT","STAGE20_DONE",
            "STAGE30_IN","STAGE30_OUT","STAGE30_DONE",
            "STAGE40_IN","STAGE40_OUT","STAGE40_DONE",
          ]
          for k in keys:
            v = os.environ.get(k,"")
            if v:
              h = hashlib.sha256(v.encode()).hexdigest()[:12]
              print(f"{k}: len={len(v)} sha256_12={h} startswith_/={v.startswith('/')}")
            else:
              print(f"{k}: len=0 sha256_12=EMPTY startswith_/=False")
          print("== secrets present? (length only) ==")
          for k in ["OPENAI_API_KEY","DROPBOX_REFRESH_TOKEN","DROPBOX_APP_KEY","DROPBOX_APP_SECRET"]:
            v = os.environ.get(k,"")
            print(f"{k}: len={len(v)}")
          PY

      - name: Run monthly_main
        shell: bash
        run: |
          set -euxo pipefail
          python -V
          python -m compileall -q src
          python -c "import src.monthly_main; print('import ok')"
          python - <<'PY'
          import runpy, sys, time, traceback
          t0 = time.time()
          try:
            print("[wrapper] START src.monthly_main")
            runpy.run_module("src.monthly_main", run_name="__main__")
          except SystemExit as e:
            print(f"[wrapper] SystemExit: code={e.code!r}", file=sys.stderr)
            raise
          except Exception:
            print("[wrapper] Unhandled exception:", file=sys.stderr)
            traceback.print_exc()
            sys.exit(1)
          finally:
            print(f"[wrapper] END (elapsed_s={time.time()-t0:.2f})")
          PY

      # ★ここが修正点：secrets ではなく env を見る
      - name: Write DONE marker to stage40/OUT (no overwrite)
        if: ${{ env.MONTHLY_STAGE == '40' }}
        shell: bash
        run: |
          set -euxo pipefail
          python - <<'PY'
          import os
          from datetime import datetime, timezone
          import dropbox
          from dropbox.files import WriteMode
          from dropbox.exceptions import ApiError

          tok = os.environ["DROPBOX_REFRESH_TOKEN"]
          app_key = os.environ["DROPBOX_APP_KEY"]
          app_secret = os.environ["DROPBOX_APP_SECRET"]
          out_dir = (os.environ.get("STAGE40_OUT","") or "").rstrip("/")

          if not out_dir.startswith("/"):
            raise SystemExit(f"STAGE40_OUT is invalid: {out_dir!r}")

          now = datetime.now(timezone.utc)
          ym = now.strftime("%Y-%m")
          fname = f"_DONE_{ym}.txt"
          body = f"{ym} monthly pipeline finished (stage40)\n"
          path = f"{out_dir}/{fname}"

          dbx = dropbox.Dropbox(oauth2_refresh_token=tok, app_key=app_key, app_secret=app_secret)

          try:
            res = dbx.files_upload(
              body.encode("utf-8"),
              path,
              mode=WriteMode.add,   # 上書きしない
              autorename=True,      # 同名は別名化
              mute=True,
            )
            print("uploaded:", res.path_display)
          except ApiError as e:
            print("ERROR uploading marker:", e)
            raise
          PY
