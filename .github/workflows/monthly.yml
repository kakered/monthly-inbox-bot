name: Run monthly-report pipeline (Excel)

on:
  workflow_dispatch:
    inputs:
      stage:
        description: "Which stage to run (00, 10, 20)"
        required: true
        default: "00"
        type: choice
        options:
          - "00"
          - "10"
          - "20"
  schedule:
    # 自動は 00 だけ回す（段階はあなたが手動で進める）
    - cron: "*/22 * * * *"

concurrency:
  group: monthly-inbox-bot
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DROPBOX_REFRESH_TOKEN: ${{ secrets.DROPBOX_REFRESH_TOKEN }}
      DROPBOX_APP_KEY: ${{ secrets.DROPBOX_APP_KEY }}
      DROPBOX_APP_SECRET: ${{ secrets.DROPBOX_APP_SECRET }}

      # ---- Base paths (Dropbox) ----
      # ここは (1) の方に合わせて Secrets を設定してください
      BASE_DIR: ${{ secrets.MONTHLY_BASE_DIR }} # 例: /Apps/monthly-inbox-bot (1)

      # ---- Stage folders ----
      STAGE00_IN:   ${{ secrets.STAGE00_IN }}
      STAGE00_DONE: ${{ secrets.STAGE00_DONE }}
      STAGE00_OUT:  ${{ secrets.STAGE00_OUT }}

      STAGE10_IN:   ${{ secrets.STAGE10_IN }}
      STAGE10_DONE: ${{ secrets.STAGE10_DONE }}
      STAGE10_OUT:  ${{ secrets.STAGE10_OUT }}

      STAGE20_IN:   ${{ secrets.STAGE20_IN }}
      STAGE20_DONE: ${{ secrets.STAGE20_DONE }}
      STAGE20_OUT:  ${{ secrets.STAGE20_OUT }}

      LOGS_DIR: ${{ secrets.LOGS_DIR }}         # 例: /Apps/monthly-inbox-bot (1)/logs
      STATE_PATH: ${{ secrets.STATE_PATH }}     # 例: /Apps/monthly-inbox-bot (1)/state.json

      # ---- runtime knobs ----
      OPENAI_MODEL: gpt-5-mini
      DEPTH: medium
      OPENAI_TIMEOUT: 120
      OPENAI_MAX_RETRIES: 2
      OPENAI_MAX_OUTPUT_TOKENS: 5000
      MAX_FILES_PER_RUN: 200
      MAX_INPUT_CHARS: 80000
      PYTHONUNBUFFERED: 1

      # stage selection:
      MONTHLY_STAGE: ${{ github.event_name == 'schedule' && '00' || inputs.stage }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pipeline (debug wrapper)
        shell: bash
        run: |
          set -euxo pipefail
          python -V
          python - <<'PY'
          import runpy, sys, traceback
          try:
              runpy.run_module("src.monthly_main", run_name="__main__")
          except SystemExit as e:
              print(f"[wrapper] SystemExit: code={e.code!r}", file=sys.stderr)
              raise
          except Exception:
              print("[wrapper] Unhandled exception:", file=sys.stderr)
              traceback.print_exc()
              sys.exit(1)
          PY