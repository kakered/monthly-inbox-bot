name: inbox-bot (monthly)

on:
  workflow_dispatch:
  schedule:
    # 例: 22分おき（必要なら調整）
    - cron: "*/22 * * * *"

concurrency:
  group: monthly-inbox-bot
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 変数が "空" で渡っていないかを見える化（秘密は出さない）
      - name: Sanity check Dropbox paths (no secret leak)
        shell: bash
        env:
          BASE_DIR: ${{ vars.BASE_DIR }}
          LOGS_DIR: ${{ vars.LOGS_DIR }}

          STAGE00_IN: ${{ vars.STAGE00_IN }}
          STAGE00_OUT: ${{ vars.STAGE00_OUT }}
          STAGE00_DONE: ${{ vars.STAGE00_DONE }}

          STAGE10_IN: ${{ vars.STAGE10_IN }}
          STAGE10_OUT: ${{ vars.STAGE10_OUT }}
          STAGE10_DONE: ${{ vars.STAGE10_DONE }}

          STAGE20_IN: ${{ vars.STAGE20_IN }}
          STAGE20_OUT: ${{ vars.STAGE20_OUT }}
          STAGE20_DONE: ${{ vars.STAGE20_DONE }}

          STAGE30_IN: ${{ vars.STAGE30_IN }}
          STAGE30_OUT: ${{ vars.STAGE30_OUT }}
          STAGE30_DONE: ${{ vars.STAGE30_DONE }}

          STAGE40_IN: ${{ vars.STAGE40_IN }}
          STAGE40_OUT: ${{ vars.STAGE40_OUT }}
          STAGE40_DONE: ${{ vars.STAGE40_DONE }}

          MONTHLY_STAGE: ${{ vars.MONTHLY_STAGE }}
          STATE_PATH: ${{ secrets.STATE_PATH }}
        run: |
          python - <<'PY'
          import os, hashlib

          keys = [
            "BASE_DIR","LOGS_DIR",
            "STAGE00_IN","STAGE00_OUT","STAGE00_DONE",
            "STAGE10_IN","STAGE10_OUT","STAGE10_DONE",
            "STAGE20_IN","STAGE20_OUT","STAGE20_DONE",
            "STAGE30_IN","STAGE30_OUT","STAGE30_DONE",
            "STAGE40_IN","STAGE40_OUT","STAGE40_DONE",
            "MONTHLY_STAGE","STATE_PATH",
          ]

          def short(v: str) -> str:
            if v is None:
              return "None"
            s = str(v)
            h = hashlib.sha256(s.encode("utf-8")).hexdigest()[:12]
            return f"len={len(s)} sha256_12={h} startswith_/={s.startswith('/') if s else False}"

          for k in keys:
            v = os.getenv(k)
            print(f"{k}: {short(v)}")
          PY

      - name: Run pipeline (debug wrapper)
        shell: bash --noprofile --norc -e -o pipefail {0}
        env:
          # --- Secrets ---
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DROPBOX_REFRESH_TOKEN: ${{ secrets.DROPBOX_REFRESH_TOKEN }}
          DROPBOX_APP_KEY: ${{ secrets.DROPBOX_APP_KEY }}
          DROPBOX_APP_SECRET: ${{ secrets.DROPBOX_APP_SECRET }}
          STATE_PATH: ${{ secrets.STATE_PATH }}

          # --- Repository variables（ここが今回の本体：vars → env へ明示的に渡す）---
          BASE_DIR: ${{ vars.BASE_DIR }}
          LOGS_DIR: ${{ vars.LOGS_DIR }}

          STAGE00_IN: ${{ vars.STAGE00_IN }}
          STAGE00_OUT: ${{ vars.STAGE00_OUT }}
          STAGE00_DONE: ${{ vars.STAGE00_DONE }}

          STAGE10_IN: ${{ vars.STAGE10_IN }}
          STAGE10_OUT: ${{ vars.STAGE10_OUT }}
          STAGE10_DONE: ${{ vars.STAGE10_DONE }}

          STAGE20_IN: ${{ vars.STAGE20_IN }}
          STAGE20_OUT: ${{ vars.STAGE20_OUT }}
          STAGE20_DONE: ${{ vars.STAGE20_DONE }}

          STAGE30_IN: ${{ vars.STAGE30_IN }}
          STAGE30_OUT: ${{ vars.STAGE30_OUT }}
          STAGE30_DONE: ${{ vars.STAGE30_DONE }}

          STAGE40_IN: ${{ vars.STAGE40_IN }}
          STAGE40_OUT: ${{ vars.STAGE40_OUT }}
          STAGE40_DONE: ${{ vars.STAGE40_DONE }}

          # スイッチ（半自動）：Repository variables に MONTHLY_STAGE を入れて切替
          # 例: 00 / 10 / 20 / 30 / 40
          MONTHLY_STAGE: ${{ vars.MONTHLY_STAGE || '00' }}

          # --- Optional tuning ---
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'gpt-5-mini' }}
          DEPTH: ${{ vars.DEPTH || 'medium' }}
          OPENAI_TIMEOUT: ${{ vars.OPENAI_TIMEOUT || '120' }}
          OPENAI_MAX_RETRIES: ${{ vars.OPENAI_MAX_RETRIES || '2' }}
          OPENAI_MAX_OUTPUT_TOKENS: ${{ vars.OPENAI_MAX_OUTPUT_TOKENS || '5000' }}
          MAX_FILES_PER_RUN: ${{ vars.MAX_FILES_PER_RUN || '200' }}
          MAX_INPUT_CHARS: ${{ vars.MAX_INPUT_CHARS || '80000' }}
          PYTHONUNBUFFERED: "1"
        run: |
          set -euxo pipefail
          python -V

          python - <<'PY'
          import runpy, sys, traceback
          try:
              runpy.run_module("src.monthly_main", run_name="__main__")
          except SystemExit as e:
              print(f"[wrapper] SystemExit: code={e.code!r}", file=sys.stderr)
              raise
          except Exception:
              print("[wrapper] Unhandled exception:", file=sys.stderr)
              traceback.print_exc()
              sys.exit(1)
          PY