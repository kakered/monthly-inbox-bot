name: inbox-bot (monthly)

on:
  workflow_dispatch:
    inputs:
      monthly_stage:
        description: "Which stage to run (00/10/20/30/40)."
        required: true
        default: "00"
        type: choice
        options:
          - "00"
          - "10"
          - "20"
          - "30"
          - "40"

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ---- Sanity check: show only lengths/hashes (no secret leak) ----
      - name: Sanity check Dropbox paths (no secret leak)
        shell: bash
        env:
          # Repo variables (plain text)
          LOGS_DIR: ${{ vars.LOGS_DIR }}
          STAGE00_IN: ${{ vars.STAGE00_IN }}
          STAGE00_OUT: ${{ vars.STAGE00_OUT }}
          STAGE00_DONE: ${{ vars.STAGE00_DONE }}
          STAGE10_IN: ${{ vars.STAGE10_IN }}
          STAGE10_OUT: ${{ vars.STAGE10_OUT }}
          STAGE10_DONE: ${{ vars.STAGE10_DONE }}
          STAGE20_IN: ${{ vars.STAGE20_IN }}
          STAGE20_OUT: ${{ vars.STAGE20_OUT }}
          STAGE20_DONE: ${{ vars.STAGE20_DONE }}
          STAGE30_IN: ${{ vars.STAGE30_IN }}
          STAGE30_OUT: ${{ vars.STAGE30_OUT }}
          STAGE30_DONE: ${{ vars.STAGE30_DONE }}
          STAGE40_IN: ${{ vars.STAGE40_IN }}
          STAGE40_OUT: ${{ vars.STAGE40_OUT }}
          STAGE40_DONE: ${{ vars.STAGE40_DONE }}
          # Secrets
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DROPBOX_REFRESH_TOKEN: ${{ secrets.DROPBOX_REFRESH_TOKEN }}
          DROPBOX_APP_KEY: ${{ secrets.DROPBOX_APP_KEY }}
          DROPBOX_APP_SECRET: ${{ secrets.DROPBOX_APP_SECRET }}
          STATE_PATH: ${{ secrets.STATE_PATH }}
        run: |
          set -euxo pipefail

          echo "===== begin python stdin (sanity-check) ====="
          cat <<'PY'
          import os, hashlib

          def short_hash(s: str) -> str:
            return hashlib.sha256(s.encode("utf-8")).hexdigest()[:12]

          keys = [
            "LOGS_DIR",
            "STAGE00_IN","STAGE00_OUT","STAGE00_DONE",
            "STAGE10_IN","STAGE10_OUT","STAGE10_DONE",
            "STAGE20_IN","STAGE20_OUT","STAGE20_DONE",
            "STAGE30_IN","STAGE30_OUT","STAGE30_DONE",
            "STAGE40_IN","STAGE40_OUT","STAGE40_DONE",
          ]
          for k in keys:
            v = os.environ.get(k, "")
            print(f"{k}: len={len(v)} sha256_12={short_hash(v) if v else 'EMPTY'} startswith_/={v.startswith('/') if v else False}")

          print("== secrets present? (length only) ==")
          for k in ["OPENAI_API_KEY","DROPBOX_REFRESH_TOKEN","DROPBOX_APP_KEY","DROPBOX_APP_SECRET","STATE_PATH"]:
            v = os.environ.get(k, "")
            print(f"{k}: len={len(v)}")
          PY
          echo "===== end python stdin (sanity-check) ====="

          # NOTE: do not fail the whole job even if this sanity-check script exits non-zero
          python - <<'PY'
          import os, hashlib

          def short_hash(s: str) -> str:
            return hashlib.sha256(s.encode("utf-8")).hexdigest()[:12]

          keys = [
            "LOGS_DIR",
            "STAGE00_IN","STAGE00_OUT","STAGE00_DONE",
            "STAGE10_IN","STAGE10_OUT","STAGE10_DONE",
            "STAGE20_IN","STAGE20_OUT","STAGE20_DONE",
            "STAGE30_IN","STAGE30_OUT","STAGE30_DONE",
            "STAGE40_IN","STAGE40_OUT","STAGE40_DONE",
          ]
          for k in keys:
            v = os.environ.get(k, "")
            print(f"{k}: len={len(v)} sha256_12={short_hash(v) if v else 'EMPTY'} startswith_/={v.startswith('/') if v else False}")

          print("== secrets present? (length only) ==")
          for k in ["OPENAI_API_KEY","DROPBOX_REFRESH_TOKEN","DROPBOX_APP_KEY","DROPBOX_APP_SECRET","STATE_PATH"]:
            v = os.environ.get(k, "")
            print(f"{k}: len={len(v)}")
          PY || true

      - name: Run pipeline (debug wrapper)
        shell: bash
        env:
          # Secrets
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DROPBOX_REFRESH_TOKEN: ${{ secrets.DROPBOX_REFRESH_TOKEN }}
          DROPBOX_APP_KEY: ${{ secrets.DROPBOX_APP_KEY }}
          DROPBOX_APP_SECRET: ${{ secrets.DROPBOX_APP_SECRET }}
          STATE_PATH: ${{ secrets.STATE_PATH }}

          # Repo variables (plain text)
          LOGS_DIR: ${{ vars.LOGS_DIR }}
          STAGE00_IN: ${{ vars.STAGE00_IN }}
          STAGE00_OUT: ${{ vars.STAGE00_OUT }}
          STAGE00_DONE: ${{ vars.STAGE00_DONE }}
          STAGE10_IN: ${{ vars.STAGE10_IN }}
          STAGE10_OUT: ${{ vars.STAGE10_OUT }}
          STAGE10_DONE: ${{ vars.STAGE10_DONE }}
          STAGE20_IN: ${{ vars.STAGE20_IN }}
          STAGE20_OUT: ${{ vars.STAGE20_OUT }}
          STAGE20_DONE: ${{ vars.STAGE20_DONE }}
          STAGE30_IN: ${{ vars.STAGE30_IN }}
          STAGE30_OUT: ${{ vars.STAGE30_OUT }}
          STAGE30_DONE: ${{ vars.STAGE30_DONE }}
          STAGE40_IN: ${{ vars.STAGE40_IN }}
          STAGE40_OUT: ${{ vars.STAGE40_OUT }}
          STAGE40_DONE: ${{ vars.STAGE40_DONE }}

          # Controls
          MONTHLY_STAGE: ${{ inputs.monthly_stage }}
          OPENAI_MODEL: gpt-5-mini
          DEPTH: medium
          OPENAI_TIMEOUT: "120"
          OPENAI_MAX_RETRIES: "2"
          OPENAI_MAX_OUTPUT_TOKENS: "5000"
          MAX_FILES_PER_RUN: "200"
          MAX_INPUT_CHARS: "80000"
          PYTHONUNBUFFERED: "1"

        run: |
          set -euxo pipefail
          python -V
          python - <<'PY'
          import runpy, sys, traceback
          try:
              runpy.run_module("src.monthly_main", run_name="__main__")
          except SystemExit as e:
              print(f"[wrapper] SystemExit: code={e.code!r}", file=sys.stderr)
              raise
          except Exception:
              print("[wrapper] Unhandled exception:", file=sys.stderr)
              traceback.print_exc()
              sys.exit(1)
          PY
